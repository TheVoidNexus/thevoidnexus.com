const translations = {
    en: {
        page_title: "TheVoidNexus - Homepage",
        nav_brand: "TheVoidNexus",
        nav_about: "About",
        nav_projects: "Projects",
        nav_skills: "Skills",
        nav_contact: "Contact",
        hero_avatar_alt: "Developer Avatar",
        hero_name: "TheVoidNexus",
        hero_title: "Web Developer",
        hero_cta_button: "View My Projects",
        hero_location_combined: "Västra Götaland, Sweden",
        hero_weather_icon_alt: "Weather loading icon",
        hero_weather_loading: "Loading...",
        github_aria_label: "GitHub Profile",
        discord_aria_label: "Discord Profile",
        about_title: "About Me",
        about_p1_text1: "Hi, I'm ",
        about_p1_name: "TheVoidNexus",
        about_p1_text2: ".",
        about_p2_text1: "When I'm not coding, I like learning about new technologies, playing games, and enjoying the peaceful beauty of ",
        about_p2_country: "Sweden",
        about_p2_text2: ".",
        projects_title: "Projects",
        project1_title: "TVN Manager",
        project1_desc: "A useful subscription manager with a calender overview, platform sync, multiple currencies and more.",
        project_view_live: "View Live",
        project_github_repo: "GitHub Repo",
        project2_title: "VoidClicker",
        project2_desc: "An engaging clicker game inspired by Cookie Clicker, with interesting mechanics and upgrades.",
        project3_title: "Polyrythm",
        project3_desc: "A rhythm-based program with dynamic beats and patterns.",
        skills_title: "My Skills",
        skill_js_alt: "JavaScript icon",
        skill_js_name: "JavaScript",
        skill_react_alt: "React icon",
        skill_react_name: "React",
        skill_java_alt: "Java icon",
        skill_java_name: "Java",
        skill_tailwind_alt: "Tailwind CSS icon",
        skill_tailwind_name: "Tailwind CSS",
        contact_title: "Contact Me",
        contact_intro: "Interested in working together or have a question? Feel free to reach out!",
        contact_email: "thevoidnexus2@gmail.com",
        footer_copyright: "© 2025 TheVoidNexus"
    },
    sv: {
        page_title: "TheVoidNexus - Hemsida",
        nav_brand: "TheVoidNexus",
        nav_about: "Om",
        nav_projects: "Projekt",
        nav_skills: "Färdigheter",
        nav_contact: "Kontakt",
        hero_avatar_alt: "Utvecklaravatar",
        hero_name: "TheVoidNexus",
        hero_title: "Webbutvecklare",
        hero_cta_button: "Visa Mina Projekt",
        hero_location_combined: "Västra Götaland, Sverige",
        hero_weather_icon_alt: "Väderikon laddas",
        hero_weather_loading: "Laddar...",
        github_aria_label: "GitHub-profil",
        discord_aria_label: "Discord-profil",
        about_title: "Om Mig",
        about_p1_text1: "Hej, jag är ",
        about_p1_name: "TheVoidNexus",
        about_p1_text2: ".",
        about_p2_text1: "När jag inte kodar gillar jag att lära mig om ny teknik, spela spel och njuta av den fridfulla skönheten i ",
        about_p2_country: "Sverige",
        about_p2_text2: ".",
        projects_title: "Projekt",
        project1_title: "TVN Manager",
        project1_desc: "En användbar prenumerationshanterare med kalenderöversikt, plattformssynkronisering, flera valutor och mer.",
        project_view_live: "Visa Live",
        project_github_repo: "GitHub-repo",
        project2_title: "VoidClicker",
        project2_desc: "Ett engagerande klickerspel inspirerat av Cookie Clicker, med intressant mekanik och uppgraderingar.",
        project3_title: "Polyrythm",
        project3_desc: "Ett rytmbaserat program med dynamiska takter och mönster.",
        skills_title: "Mina Färdigheter",
        skill_js_alt: "JavaScript-ikon",
        skill_js_name: "JavaScript",
        skill_react_alt: "React-ikon",
        skill_react_name: "React",
        skill_java_alt: "Java-ikon",
        skill_java_name: "Java",
        skill_tailwind_alt: "Tailwind CSS-ikon",
        skill_tailwind_name: "Tailwind CSS",
        contact_title: "Kontakta Mig",
        contact_intro: "Intresserad av att arbeta tillsammans eller har du en fråga? Hör gärna av dig!",
        contact_email: "thevoidnexus2@gmail.com",
        footer_copyright: "© 2025 TheVoidNexus"
    },
    de: {
        page_title: "TheVoidNexus - Startseite",
        nav_brand: "TheVoidNexus",
        nav_about: "Über",
        nav_projects: "Projekte",
        nav_skills: "Fähigkeiten",
        nav_contact: "Kontakt",
        hero_avatar_alt: "Entwickler-Avatar",
        hero_name: "TheVoidNexus",
        hero_title: "Webentwickler",
        hero_cta_button: "Meine Projekte ansehen",
        hero_location_combined: "Västra Götaland, Schweden",
        hero_weather_icon_alt: "Wetter Ladesymbol",
        hero_weather_loading: "Lädt...",
        github_aria_label: "GitHub Profil",
        discord_aria_label: "Discord Profil",
        about_title: "Über mich",
        about_p1_text1: "Hallo, ich bin ",
        about_p1_name: "TheVoidNexus",
        about_p1_text2: ".",
        about_p2_text1: "Wenn ich nicht gerade programmiere, lerne ich gerne neue Technologien kennen, spiele Spiele und genieße die friedliche Schönheit von ",
        about_p2_country: "Schweden",
        about_p2_text2: ".",
        projects_title: "Projekte",
        project1_title: "TVN Manager",
        project1_desc: "Ein nützlicher Abonnement-Manager mit Kalenderübersicht, Plattform-Synchronisierung, mehreren Währungen und mehr.",
        project_view_live: "Live ansehen",
        project_github_repo: "GitHub Repo",
        project2_title: "VoidClicker",
        project2_desc: "Ein fesselndes Klickerspiel, inspiriert von Cookie Clicker, mit interessanten Mechaniken und Upgrades.",
        project3_title: "Polyrythm",
        project3_desc: "Ein rhythmusbasiertes Programm mit dynamischen Beats und Mustern.",
        skills_title: "Meine Fähigkeiten",
        skill_js_alt: "JavaScript-Symbol",
        skill_js_name: "JavaScript",
        skill_react_alt: "React-Symbol",
        skill_react_name: "React",
        skill_java_alt: "Java-Symbol",
        skill_java_name: "Java",
        skill_tailwind_alt: "Tailwind CSS-Symbol",
        skill_tailwind_name: "Tailwind CSS",
        contact_title: "Kontaktiere mich",
        contact_intro: "Interessiert an einer Zusammenarbeit oder hast du eine Frage? Zögere nicht, mich zu kontaktieren!",
        contact_email: "thevoidnexus2@gmail.com",
        footer_copyright: "© 2025 TheVoidNexus"
    }
};

let currentActiveLanguage;

function getInitialLanguage() {
    let lang = localStorage.getItem('PreferredLanguage');
    if (!lang) {
        const browserLangFull = (navigator.language || navigator.userLanguage || 'en').toLowerCase();
        const browserLangBase = browserLangFull.split('-')[0];
        if (browserLangBase === 'de') lang = 'de';
        else if (browserLangBase === 'sv') lang = 'sv';
        else lang = 'en';
    }
    const supported = (typeof translations !== 'undefined' && translations) ? Object.keys(translations) : ['en', 'de', 'sv'];
    if (!supported.includes(lang)) {
        lang = 'en';
    }
    return lang;
}

function setLanguage(lang) {
    if (!lang) {
        return;
    }
    const normalizedLang = lang.toLowerCase();

    if (typeof translations === 'undefined' || !translations || !translations[normalizedLang]) {
        if (normalizedLang !== 'en') {
            setLanguage('en');
        }
        return;
    }

    localStorage.setItem('PreferredLanguage', normalizedLang);
    document.documentElement.lang = normalizedLang;
    currentActiveLanguage = normalizedLang;

    const titleElement = document.querySelector('title[data-translate-title]');
    if (titleElement) {
        const titleKey = titleElement.getAttribute('data-translate-title');
        if (translations[normalizedLang][titleKey]) {
            document.title = translations[normalizedLang][titleKey];
        }
    }

    document.querySelectorAll('[data-translate], [data-translate-alt], [data-translate-aria-label]').forEach(element => {
        const translateKey = element.getAttribute('data-translate');
        const altKey = element.getAttribute('data-translate-alt');
        const ariaLabelKey = element.getAttribute('data-translate-aria-label');

        if (translateKey && translations[normalizedLang][translateKey]) {
            if (element.hasAttribute('placeholder')) element.placeholder = translations[normalizedLang][translateKey];
            else element.textContent = translations[normalizedLang][translateKey];
        }

        if (altKey && translations[normalizedLang][altKey]) {
            element.alt = translations[normalizedLang][altKey];
        }

        if (ariaLabelKey && translations[normalizedLang][ariaLabelKey]) {
            element.setAttribute('aria-label', translations[normalizedLang][ariaLabelKey]);
        }
    });

    updateLanguageSwitcherUI(normalizedLang);

    if (typeof window.updateDropdownDisplayCallback === 'function') {
        window.updateDropdownDisplayCallback(normalizedLang);
    }

    if (typeof fetchWeather === 'function') {
        fetchWeather();
    }
}

function updateLanguageSwitcherUI(activeLangLowercase) {
    const langsToUpdate = ['en', 'de', 'sv'];
    langsToUpdate.forEach(langCode => {
        const button = document.getElementById(`lang-${langCode}`);
        if (button) {
            if (langCode === activeLangLowercase) {
                button.classList.add('active-lang');
                button.classList.remove('inactive-lang');
            } else {
                button.classList.remove('active-lang');
                button.classList.add('inactive-lang');
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', () => {
    const flags = {
        EN: `<svg width="24" height="16" viewBox="0 0 24 16" class="flag-svg h-4 w-6" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="16" fill="#012169"/><path d="M0 0L24 16M0 16L24 0" stroke="white" stroke-width="3.2"/><path d="M0 0L24 16M0 16L24 0" stroke="#C8102E" stroke-width="2"/><path d="M12 0V16M0 8H24" stroke="white" stroke-width="4.8"/><path d="M12 0V16M0 8H24" stroke="#C8102E" stroke-width="3.2"/></svg>`,
        DE: `<svg width="24" height="16" viewBox="0 0 24 16" class="flag-svg h-4 w-6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill="#000000" d="M0 0h24v5.333H0z"/><path fill="#D00000" d="M0 5.333h24v5.334H0z"/><path fill="#FFCE00" d="M0 10.667h24v5.333H0z"/></svg>`,
        SV: `<svg width="24" height="16" viewBox="0 0 24 16" class="flag-svg h-4 w-6" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="16" fill="#006AA7"/><path fill="#FFCD00" d="M0 6.4h24v3.2H0z"/><path fill="#FFCD00" d="M7 0h4v16H7z"/></svg>`
    };
    const languageNames = { EN: 'English', DE: 'Deutsch', SV: 'Svenska' };

    const dropdownButton = document.getElementById('language-dropdown-button');
    const dropdownMenu = document.getElementById('language-dropdown-menu');
    const selectedLangTextEl = document.getElementById('selected-lang-text');
    const selectedLangFlagContainerEl = document.getElementById('selected-lang-flag-container');

    window.updateDropdownDisplayCallback = function(activeLangLowercase) {
        if (!selectedLangTextEl || !selectedLangFlagContainerEl) return;
        const activeLangUppercase = activeLangLowercase.toUpperCase();
        selectedLangTextEl.textContent = languageNames[activeLangUppercase] || activeLangUppercase;
        selectedLangFlagContainerEl.innerHTML = flags[activeLangUppercase] || '';
    };

    currentActiveLanguage = getInitialLanguage();

    if (dropdownButton && dropdownMenu) {
        dropdownButton.addEventListener('click', (event) => {
            event.stopPropagation();
            const isExpanded = dropdownButton.getAttribute('aria-expanded') === 'true';
            dropdownButton.setAttribute('aria-expanded', String(!isExpanded));
            dropdownMenu.classList.toggle('hidden');
        });

        document.addEventListener('click', (event) => {
            if (dropdownButton && !dropdownButton.contains(event.target) &&
                dropdownMenu && !dropdownMenu.contains(event.target)) {
                dropdownMenu.classList.add('hidden');
                dropdownButton.setAttribute('aria-expanded', 'false');
            }
        });

        dropdownMenu.querySelectorAll('a[data-lang]').forEach(item => {
            item.addEventListener('click', (event) => {
                event.preventDefault();
                const langAttr = item.getAttribute('data-lang');
                if (langAttr) {
                    setLanguage(langAttr.toLowerCase());
                    dropdownMenu.classList.add('hidden');
                    dropdownButton.setAttribute('aria-expanded', 'false');
                }
            });
        });
    }

    if (dropdownMenu) {
        dropdownMenu.querySelectorAll('a[data-lang]').forEach(item => {
            const langAttr = item.getAttribute('data-lang');
            const flagPlaceholder = item.querySelector('.flag-icon-placeholder');
            if (flagPlaceholder && flags[langAttr]) {
                flagPlaceholder.innerHTML = flags[langAttr];
            }
        });
    }
    setLanguage(currentActiveLanguage);
});